<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•¸ç¥ MathGod</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        [v-cloak] { display: none; }
        body { background-color: #121212; color: #e5e7eb; font-family: sans-serif; }
        .evergreen-gradient { background: linear-gradient(135deg, #059669 0%, #064e3b 100%); }
        .card-bg { background-color: #1e1e1e; border: 1px solid rgba(255,255,255,0.05); }
        .input-bg { background-color: #2d2d2d; color: white; border: 1px solid rgba(255,255,255,0.1); }
        /* å¼·åŒ–æˆªåœ–å€åŸŸæ–‡å­—å°æ¯”ï¼Œé˜²æ­¢ç©ºç™½ */
        #capture-zone { background-color: #121212 !important; color: #ffffff !important; padding: 20px; border-radius: 24px; }
        .settle-card { background-color: #1a1a1a !important; border: 1px solid #333 !important; }
        .tab-active { background-color: #10b981; color: white; }
    </style>
</head>
<body>
<div id="app" v-cloak class="max-w-md mx-auto min-h-screen pb-10">
    
    <header class="evergreen-gradient text-white p-6 sticky top-0 z-20 shadow-lg rounded-b-3xl">
        <div class="flex justify-between items-center">
            <h1 class="text-2xl font-black italic italic"><i class="fas fa-bolt text-yellow-400"></i> æ•¸ç¥</h1>
            <div class="flex gap-2">
                <button @click="showTextShare = true" class="bg-white/10 px-4 py-2 rounded-full text-[10px] font-bold">æ–‡å­—</button>
                <button @click="generateImage" class="bg-white/20 px-4 py-2 rounded-full text-[10px] font-bold">æˆªåœ–</button>
            </div>
        </div>
    </header>

    <div class="p-4 space-y-6">
        <div id="capture-zone">
            <div class="mb-6 flex justify-between items-end">
                <div>
                    <h2 class="text-emerald-500 font-black text-xl">æœ€çµ‚çµç®—</h2>
                    <p class="text-[10px] text-gray-500">SETTLEMENT</p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-gray-500 font-bold uppercase">Total Spent</p>
                    <p class="text-emerald-500 font-mono font-bold text-lg">HK${{ totalSpent.toFixed(1) }}</p>
                </div>
            </div>

            <div v-if="settlements.length > 0" class="space-y-3 mb-6">
                <div v-for="s in settlements" class="settle-card p-4 rounded-2xl flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span class="text-rose-400 font-bold text-sm">{{ s.from }}</span>
                        <i class="fas fa-arrow-right text-[10px] text-gray-600"></i>
                        <span class="text-emerald-500 font-bold text-sm">{{ s.to }}</span>
                    </div>
                    <span class="font-mono text-emerald-500 font-bold text-lg">HK${{ s.amount.toFixed(1) }}</span>
                </div>
            </div>

            <div class="space-y-3">
                <div v-for="exp in expenses" :key="exp.id" class="card-bg p-4 rounded-2xl border-l-4 border-emerald-600 flex justify-between items-center">
                    <div>
                        <div class="text-white font-bold text-sm mb-1">{{ exp.item }}</div>
                        <div class="text-[10px] text-gray-400">
                            <span class="text-emerald-500 font-bold">{{ exp.payer }}</span> ä»˜ {{ exp.currency }} {{ exp.amount }}
                        </div>
                    </div>
                    <div class="text-right font-mono font-bold text-gray-200">HK${{ exp.hkd.toFixed(1) }}</div>
                </div>
            </div>
        </div>

        <section class="card-bg p-6 rounded-3xl space-y-4">
            <input v-model="newUser" @keyup.enter="addUser" placeholder="åŠ æœ‹å‹åç¨±..." class="input-bg w-full p-3 rounded-xl text-sm outline-none">
            <div class="flex flex-wrap gap-2 mb-4">
                <span v-for="(u, i) in users" class="bg-emerald-500/10 text-emerald-500 px-3 py-1 rounded-lg text-xs font-bold">{{ u }} <button @click="users.splice(i,1)">Ã—</button></span>
            </div>

            <input v-model="form.item" placeholder="é …ç›® (å¦‚: åƒé¦™è•‰)" class="input-bg w-full p-4 rounded-2xl text-sm outline-none">
            <div class="flex gap-2">
                <select v-model="form.currency" @change="fetchRate" class="input-bg p-4 rounded-2xl text-sm w-1/3 font-bold">
                    <option value="HKD">ğŸ‡­ğŸ‡° HKD</option>
                    <option value="JPY">ğŸ‡¯ğŸ‡µ JPY</option>
                    <option value="TWD">ğŸ‡¹ğŸ‡¼ TWD</option>
                    <option value="THB">ğŸ‡¹ğŸ‡­ THB</option>
                </select>
                <input v-model.number="form.amount" type="number" placeholder="é‡‘é¡" class="input-bg flex-1 p-4 rounded-2xl text-sm text-right font-mono font-bold">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] text-gray-500 ml-1">èª°ä»˜æ¬¾</label>
                    <select v-model="form.payer" class="input-bg w-full p-3 rounded-xl text-sm mt-1">
                        <option v-for="u in users" :value="u">{{ u }}</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] text-gray-500 ml-1">èª°åƒèˆ‡</label>
                    <div class="input-bg p-2 rounded-xl text-[10px] h-24 overflow-y-auto mt-1">
                        <div v-for="u in users" class="flex items-center gap-2 mb-1">
                            <input type="checkbox" :value="u" v-model="form.involved" class="accent-emerald-500"> {{ u }}
                        </div>
                    </div>
                </div>
            </div>

            <button @click="addExpense" class="evergreen-gradient w-full py-4 rounded-2xl font-bold text-sm shadow-lg active:scale-95">ç¢ºèªè¨˜å¸³</button>
        </section>

        <div v-if="previewImg" class="fixed inset-0 bg-black/90 backdrop-blur-md z-[70] flex flex-col items-center justify-center p-6" @click.self="previewImg = null">
            <img :src="previewImg" class="max-w-full max-h-[60vh] rounded-2xl shadow-2xl border border-white/10 mb-8">
            <div class="grid grid-cols-2 gap-4 w-full max-w-sm">
                <button @click="downloadImage" class="bg-gray-800 text-white py-4 rounded-2xl text-xs font-bold active:scale-95">ä¸‹è¼‰åœ–ç‰‡ (.png)</button>
                <button @click="shareImage" class="evergreen-gradient text-white py-4 rounded-2xl text-xs font-bold active:scale-95">åˆ†äº«åœ–ç‰‡</button>
            </div>
            <button @click="previewImg = null" class="mt-8 text-white/40 text-xs underline">è¿”å›ç·¨è¼¯</button>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed } = Vue;
createApp({
    setup() {
        const users = ref(['Aa', 'Bb', 'Cc']); 
        const expenses = ref([]);
        const newUser = ref("");
        const previewImg = ref(null);
        const currentRate = ref(1);
        const form = ref({ item: "", amount: "", currency: "HKD", payer: "Aa", involved: ['Aa', 'Bb', 'Cc'] });

        const addUser = () => { if(newUser.value && !users.value.includes(newUser.value)) { users.value.push(newUser.value); newUser.value = ""; } };
        
        const fetchRate = async () => {
            if(form.value.currency === 'HKD') return currentRate.value = 1;
            const res = await fetch(`https://open.er-api.com/v6/latest/${form.value.currency}`);
            const data = await res.json();
            currentRate.value = data.rates.HKD || 1;
        };

        const addExpense = () => {
            if(!form.value.item || !form.value.amount) return;
            expenses.value.unshift({ id: Date.now(), ...form.value, hkd: form.value.amount * currentRate.value, rateUsed: currentRate.value });
            form.value.item = ""; form.value.amount = "";
        };

        const generateImage = async () => {
            const element = document.getElementById('capture-zone');
            // å„ªåŒ–æ¸²æŸ“é…ç½®
            const canvas = await html2canvas(element, {
                backgroundColor: '#121212',
                scale: 3, // æé«˜æ¸…æ™°åº¦
                useCORS: true,
                logging: false,
                onclone: (doc) => {
                    // å¼·åˆ¶ä»¤å…‹éš†å‡ºä¾†ç”¨ä½œæˆªåœ–çš„ DOM æ–‡å­—é¡è‰²æ­£ç¢º
                    doc.querySelectorAll('.text-white').forEach(el => el.style.color = '#ffffff');
                }
            });
            previewImg.value = canvas.toDataURL('image/png');
        };

        const downloadImage = () => {
            const link = document.createElement('a');
            link.download = `MathGod_Result_${Date.now()}.png`; // ç¢ºä¿æœ‰ .png
            link.href = previewImg.value;
            link.click();
        };

        const shareImage = async () => {
            const res = await fetch(previewImg.value);
            const blob = await res.blob();
            const file = new File([blob], 'settlement.png', { type: 'image/png' });
            if (navigator.share) await navigator.share({ files: [file] });
        };

        const settlements = computed(() => {
            let bal = {}; users.value.forEach(u => bal[u] = 0);
            expenses.value.forEach(e => {
                bal[e.payer] += e.hkd;
                const split = e.hkd / (e.involved.length || 1);
                e.involved.forEach(p => bal[p] -= split);
            });
            let d = [], c = [], res = [];
            for(let u in bal) { if(bal[u] < -0.1) d.push({n:u, a:Math.abs(bal[u])}); if(bal[u] > 0.1) c.push({n:u, a:bal[u]}); }
            let i=0, j=0;
            while(i<d.length && j<c.length){
                let m = Math.min(d[i].a, c[j].a);
                res.push({from: d[i].n, to: c[j].n, amount: m});
                d[i].a -= m; c[j].a -= m;
                if(d[i].a < 0.1) i++; if(c[j].a < 0.1) j++;
            }
            return res;
        });

        return { users, expenses, newUser, form, previewImg, currentRate, addUser, fetchRate, addExpense, generateImage, downloadImage, shareImage, settlements, totalSpent: computed(()=>expenses.value.reduce((s,e)=>s+e.hkd,0)) };
    }
}).mount('#app');
</script>
</body>
</html>
